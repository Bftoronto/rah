<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ Telegram</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .warning { background-color: #fff3cd; color: #856404; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            background-color: #f8f9fa;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê –¢–µ—Å—Ç –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ Telegram</h1>
        
        <div class="test-section">
            <h3>1. –ü—Ä–æ–≤–µ—Ä–∫–∞ Telegram Web App</h3>
            <button onclick="checkTelegramWebApp()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å Telegram Web App</button>
            <div id="telegram-check-result" class="result"></div>
        </div>
        
        <div class="test-section">
            <h3>2. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
            <button onclick="extractUserData()">–ò–∑–≤–ª–µ—á—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
            <div id="user-data-result" class="result"></div>
        </div>
        
        <div class="test-section">
            <h3>3. –¢–µ—Å—Ç –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ (—Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)</h3>
            <button onclick="testRealVerification()">–¢–µ—Å—Ç —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏</button>
            <div id="real-verification-result" class="result"></div>
        </div>
        
        <div class="test-section">
            <h3>4. –¢–µ—Å—Ç –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ (—Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ)</h3>
            <button onclick="testMockVerification()">–¢–µ—Å—Ç —Å —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏</button>
            <div id="mock-verification-result" class="result"></div>
        </div>
        
        <div class="test-section">
            <h3>5. –ü—Ä–æ–≤–µ—Ä–∫–∞ —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ API</h3>
            <button onclick="testApiEndpoints()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å API</button>
            <div id="api-test-result" class="result"></div>
        </div>
        
        <div class="test-section">
            <h3>6. –ü–æ–ª–Ω–∞—è –∏–º–∏—Ç–∞—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</h3>
            <button onclick="simulateAppStart()">–ò–º–∏—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—É—Å–∫</button>
            <div id="app-simulation-result" class="result"></div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'https://pax-backend-2gng.onrender.com';
        
        function log(message, elementId, type = 'info') {
            const element = document.getElementById(elementId);
            const statusClass = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';
            element.innerHTML += `<div class="status ${statusClass}">${message}</div>`;
            console.log(message);
        }
        
        function clearResult(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }
        
        // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ Telegram Web App
        function checkTelegramWebApp() {
            clearResult('telegram-check-result');
            
            if (window.Telegram && window.Telegram.WebApp) {
                const tg = window.Telegram.WebApp;
                log('‚úÖ Telegram Web App –¥–æ—Å—Ç—É–ø–µ–Ω', 'telegram-check-result', 'success');
                
                try {
                    tg.expand();
                    log('‚úÖ WebApp —Ä–∞—Å—à–∏—Ä–µ–Ω', 'telegram-check-result', 'success');
                } catch (e) {
                    log('‚ö†Ô∏è –û—à–∏–±–∫–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è: ' + e.message, 'telegram-check-result', 'warning');
                }
                
                log(`<pre>InitData: ${tg.initData || '–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'}</pre>`, 'telegram-check-result');
                log(`<pre>InitDataUnsafe: ${JSON.stringify(tg.initDataUnsafe, null, 2)}</pre>`, 'telegram-check-result');
                
            } else {
                log('‚ùå Telegram Web App –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω', 'telegram-check-result', 'error');
            }
        }
        
        // 2. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function extractUserData() {
            clearResult('user-data-result');
            
            if (window.Telegram && window.Telegram.WebApp) {
                const tg = window.Telegram.WebApp;
                const initData = tg.initDataUnsafe;
                
                if (initData && initData.user) {
                    log('‚úÖ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞–π–¥–µ–Ω—ã', 'user-data-result', 'success');
                    
                    const userData = {
                        id: initData.user.id,
                        first_name: initData.user.first_name,
                        last_name: initData.user.last_name,
                        username: initData.user.username,
                        language_code: initData.user.language_code,
                        photo_url: initData.user.photo_url
                    };
                    
                    log(`<pre>${JSON.stringify(userData, null, 2)}</pre>`, 'user-data-result');
                    
                    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                    const additionalData = {
                        auth_date: initData.auth_date,
                        hash: initData.hash,
                        query_id: initData.query_id,
                        start_param: initData.start_param
                    };
                    
                    log('<strong>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:</strong>', 'user-data-result');
                    log(`<pre>${JSON.stringify(additionalData, null, 2)}</pre>`, 'user-data-result');
                    
                } else {
                    log('‚ùå –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç', 'user-data-result', 'error');
                }
            } else {
                log('‚ùå Telegram Web App –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω', 'user-data-result', 'error');
            }
        }
        
        // 3. –¢–µ—Å—Ç –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
        async function testRealVerification() {
            clearResult('real-verification-result');
            
            if (!window.Telegram || !window.Telegram.WebApp) {
                log('‚ùå Telegram Web App –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω', 'real-verification-result', 'error');
                return;
            }
            
            const tg = window.Telegram.WebApp;
            const initData = tg.initDataUnsafe;
            
            if (!initData || !initData.user) {
                log('‚ùå –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç', 'real-verification-result', 'error');
                return;
            }
            
            const verificationData = {
                user: initData.user,
                auth_date: initData.auth_date || Math.floor(Date.now() / 1000),
                hash: initData.hash || 'test_hash',
                initData: tg.initData || '',
                query_id: initData.query_id || '',
                start_param: initData.start_param || ''
            };
            
            log('–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏...', 'real-verification-result');
            log(`<pre>${JSON.stringify(verificationData, null, 2)}</pre>`, 'real-verification-result');
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/auth/telegram/verify`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(verificationData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    log('‚úÖ –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ', 'real-verification-result', 'success');
                    log(`<pre>${JSON.stringify(result, null, 2)}</pre>`, 'real-verification-result');
                } else {
                    log(`‚ö†Ô∏è –û—à–∏–±–∫–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ (${response.status})`, 'real-verification-result', 'warning');
                    log(`<pre>${JSON.stringify(result, null, 2)}</pre>`, 'real-verification-result');
                }
                
            } catch (error) {
                log('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: ' + error.message, 'real-verification-result', 'error');
            }
        }
        
        // 4. –¢–µ—Å—Ç –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Å —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
        async function testMockVerification() {
            clearResult('mock-verification-result');
            
            const mockData = {
                user: {
                    id: 123456789,
                    first_name: 'Test',
                    last_name: 'User',
                    username: 'testuser',
                    language_code: 'ru'
                },
                auth_date: Math.floor(Date.now() / 1000),
                hash: 'test_hash_123456789',
                initData: 'mock_init_data',
                query_id: 'mock_query_id',
                start_param: 'test_start'
            };
            
            log('–û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö...', 'mock-verification-result');
            log(`<pre>${JSON.stringify(mockData, null, 2)}</pre>`, 'mock-verification-result');
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/auth/telegram/verify`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(mockData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    log('‚úÖ –¢–µ—Å—Ç–æ–≤–∞—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ', 'mock-verification-result', 'success');
                    log(`<pre>${JSON.stringify(result, null, 2)}</pre>`, 'mock-verification-result');
                } else {
                    log(`‚ö†Ô∏è –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–π –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ (${response.status})`, 'mock-verification-result', 'warning');
                    log(`<pre>${JSON.stringify(result, null, 2)}</pre>`, 'mock-verification-result');
                }
                
            } catch (error) {
                log('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: ' + error.message, 'mock-verification-result', 'error');
            }
        }
        
        // 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ API
        async function testApiEndpoints() {
            clearResult('api-test-result');
            
            const endpoints = [
                '/',
                '/health',
                '/api/info'
            ];
            
            for (const endpoint of endpoints) {
                try {
                    const response = await fetch(`${API_BASE_URL}${endpoint}`);
                    const result = await response.json();
                    
                    if (response.ok) {
                        log(`‚úÖ ${endpoint}: OK`, 'api-test-result', 'success');
                    } else {
                        log(`‚ö†Ô∏è ${endpoint}: ${response.status}`, 'api-test-result', 'warning');
                    }
                } catch (error) {
                    log(`‚ùå ${endpoint}: ${error.message}`, 'api-test-result', 'error');
                }
            }
        }
        
        // 6. –ü–æ–ª–Ω–∞—è –∏–º–∏—Ç–∞—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        async function simulateAppStart() {
            clearResult('app-simulation-result');
            
            log('üöÄ –ò–º–∏—Ç–∞—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...', 'app-simulation-result');
            
            // –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ Telegram Web App
            if (window.Telegram && window.Telegram.WebApp) {
                log('‚úÖ Telegram Web App –æ–±–Ω–∞—Ä—É–∂–µ–Ω', 'app-simulation-result', 'success');
                
                const tg = window.Telegram.WebApp;
                const initData = tg.initDataUnsafe;
                
                if (initData && initData.user && initData.user.id) {
                    log('‚úÖ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞–π–¥–µ–Ω—ã', 'app-simulation-result', 'success');
                    
                    // –®–∞–≥ 2: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
                    const verificationData = {
                        initData: tg.initData,
                        initDataUnsafe: initData,
                        user: initData.user,
                        hash: initData.hash || tg.initData,
                        auth_date: initData.auth_date || Math.floor(Date.now() / 1000),
                        query_id: initData.query_id,
                        start_param: initData.start_param
                    };
                    
                    log('‚úÖ –î–∞–Ω–Ω—ã–µ –¥–ª—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω—ã', 'app-simulation-result', 'success');
                    
                    // –®–∞–≥ 3: –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é
                    try {
                        const response = await fetch(`${API_BASE_URL}/api/auth/telegram/verify`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(verificationData)
                        });
                        
                        const result = await response.json();
                        
                        if (response.ok) {
                            if (result.exists) {
                                log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–π–¥–µ–Ω –≤ —Å–∏—Å—Ç–µ–º–µ', 'app-simulation-result', 'success');
                                log('‚û°Ô∏è –ü–µ—Ä–µ—Ö–æ–¥ –∫ –≥–ª–∞–≤–Ω–æ–º—É —ç–∫—Ä–∞–Ω—É', 'app-simulation-result', 'info');
                            } else {
                                log('‚ö†Ô∏è –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å', 'app-simulation-result', 'warning');
                                log('‚û°Ô∏è –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏', 'app-simulation-result', 'info');
                            }
                        } else {
                            log(`‚ùå –û—à–∏–±–∫–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏: ${response.status}`, 'app-simulation-result', 'error');
                            log('‚û°Ô∏è –ü–µ—Ä–µ—Ö–æ–¥ –∫ —ç–∫—Ä–∞–Ω—É –æ—à–∏–±–∫–∏', 'app-simulation-result', 'info');
                        }
                        
                    } catch (error) {
                        log('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message, 'app-simulation-result', 'error');
                        log('‚û°Ô∏è –ü–µ—Ä–µ—Ö–æ–¥ –∫ —ç–∫—Ä–∞–Ω—É –æ—à–∏–±–∫–∏', 'app-simulation-result', 'info');
                    }
                    
                } else {
                    log('‚ùå –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç', 'app-simulation-result', 'error');
                    log('‚û°Ô∏è –ü–µ—Ä–µ—Ö–æ–¥ –∫ —ç–∫—Ä–∞–Ω—É –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è', 'app-simulation-result', 'info');
                }
                
            } else {
                log('‚ùå Telegram Web App –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω', 'app-simulation-result', 'error');
                log('‚û°Ô∏è –ü–µ—Ä–µ—Ö–æ–¥ –∫ —ç–∫—Ä–∞–Ω—É –æ—à–∏–±–∫–∏', 'app-simulation-result', 'info');
            }
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', function() {
            console.log('–°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –≥–æ—Ç–æ–≤–∞ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é');
        });
    </script>
</body>
</html>
