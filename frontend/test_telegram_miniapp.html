<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç Telegram Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .warning { background-color: #fff3cd; color: #856404; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç –¢–µ—Å—Ç Telegram Mini App</h1>
        
        <div id="status"></div>
        
        <h2>üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ Telegram Web App</h2>
        <div id="telegram-info"></div>
        
        <h2>üîó –¢–µ—Å—Ç API</h2>
        <button onclick="testBackend()">–¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±—ç–∫–µ–Ω–¥—É</button>
        <button onclick="testTelegramVerification()">–¢–µ—Å—Ç –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ Telegram</button>
        <div id="api-results"></div>
        
        <h2>üìù –õ–æ–≥–∏</h2>
        <pre id="logs"></pre>
    </div>

    <script>
        const statusDiv = document.getElementById('status');
        const telegramInfoDiv = document.getElementById('telegram-info');
        const apiResultsDiv = document.getElementById('api-results');
        const logsDiv = document.getElementById('logs');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            logsDiv.textContent += logEntry;
            console.log(message);
        }

        function addStatus(message, type = 'info') {
            const statusElement = document.createElement('div');
            statusElement.className = `status ${type}`;
            statusElement.textContent = message;
            statusDiv.appendChild(statusElement);
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ Telegram Web App
        function checkTelegramWebApp() {
            log('–ü—Ä–æ–≤–µ—Ä–∫–∞ Telegram Web App...');
            
            if (window.Telegram && window.Telegram.WebApp) {
                const tg = window.Telegram.WebApp;
                
                addStatus('‚úÖ Telegram Web App –¥–æ—Å—Ç—É–ø–µ–Ω', 'success');
                
                // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ Telegram Web App
                const initData = tg.initDataUnsafe;
                const user = initData?.user;
                const chat = initData?.chat;
                
                let telegramInfo = '<h3>–î–∞–Ω–Ω—ã–µ Telegram:</h3>';
                
                if (user) {
                    telegramInfo += `
                        <div class="status info">
                            <strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</strong><br>
                            ID: ${user.id}<br>
                            –ò–º—è: ${user.first_name} ${user.last_name || ''}<br>
                            Username: ${user.username || '–ù–µ —É–∫–∞–∑–∞–Ω'}<br>
                            –Ø–∑—ã–∫: ${user.language_code || '–ù–µ —É–∫–∞–∑–∞–Ω'}
                        </div>
                    `;
                } else {
                    telegramInfo += '<div class="status warning">–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                }
                
                if (chat) {
                    telegramInfo += `
                        <div class="status info">
                            <strong>–ß–∞—Ç:</strong><br>
                            ID: ${chat.id}<br>
                            –¢–∏–ø: ${chat.type}<br>
                            –ù–∞–∑–≤–∞–Ω–∏–µ: ${chat.title || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}
                        </div>
                    `;
                }
                
                telegramInfo += `
                    <div class="status info">
                        <strong>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—É—Å–∫–∞:</strong><br>
                        Start Param: ${initData?.start_param || '–ù–µ —É–∫–∞–∑–∞–Ω'}<br>
                        Auth Date: ${initData?.auth_date || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}<br>
                        Hash: ${initData?.hash ? '–ü—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç' : '–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'}
                    </div>
                `;
                
                telegramInfoDiv.innerHTML = telegramInfo;
                
                // –†–∞—Å—à–∏—Ä—è–µ–º Web App
                try {
                    tg.expand();
                    log('Web App —Ä–∞—Å—à–∏—Ä–µ–Ω');
                } catch (e) {
                    log('–û—à–∏–±–∫–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è Web App: ' + e.message, 'error');
                }
                
                // –í–∫–ª—é—á–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–∏—è
                try {
                    tg.enableClosingConfirmation();
                    log('–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–∏—è –≤–∫–ª—é—á–µ–Ω–æ');
                } catch (e) {
                    log('–û—à–∏–±–∫–∞ –≤–∫–ª—é—á–µ–Ω–∏—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è: ' + e.message, 'error');
                }
                
            } else {
                addStatus('‚ùå Telegram Web App –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –æ—Ç–∫—Ä—ã–≤–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ Telegram.', 'error');
                log('Telegram Web App –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
            }
        }

        // –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±—ç–∫–µ–Ω–¥—É
        async function testBackend() {
            log('–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±—ç–∫–µ–Ω–¥—É...');
            
            try {
                const response = await fetch('https://pax-backend-2gng.onrender.com/');
                const data = await response.json();
                
                if (response.ok) {
                    addStatus('‚úÖ –ë—ç–∫–µ–Ω–¥ –¥–æ—Å—Ç—É–ø–µ–Ω', 'success');
                    log(`–ë—ç–∫–µ–Ω–¥ –æ—Ç–≤–µ—Ç–∏–ª: ${JSON.stringify(data)}`);
                } else {
                    addStatus('‚ùå –ë—ç–∫–µ–Ω–¥ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω', 'error');
                    log(`–û—à–∏–±–∫–∞ –±—ç–∫–µ–Ω–¥–∞: ${response.status}`, 'error');
                }
            } catch (error) {
                addStatus('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±—ç–∫–µ–Ω–¥—É', 'error');
                log(`–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${error.message}`, 'error');
            }
        }

        // –¢–µ—Å—Ç –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ Telegram
        async function testTelegramVerification() {
            log('–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ Telegram...');
            
            if (!window.Telegram || !window.Telegram.WebApp) {
                addStatus('‚ùå Telegram Web App –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è', 'error');
                return;
            }
            
            const tg = window.Telegram.WebApp;
            const user = tg.initDataUnsafe?.user;
            
            if (!user) {
                addStatus('‚ùå –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã', 'error');
                return;
            }
            
            try {
                const response = await fetch('https://pax-backend-2gng.onrender.com/api/auth/telegram/verify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(user)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    addStatus('‚úÖ –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è Telegram –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ', 'success');
                    log(`–û—Ç–≤–µ—Ç –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏: ${JSON.stringify(data)}`);
                } else {
                    addStatus(`‚ùå –û—à–∏–±–∫–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏: ${response.status}`, 'error');
                    log(`–û—à–∏–±–∫–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏: ${JSON.stringify(data)}`, 'error');
                }
            } catch (error) {
                addStatus('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–∏ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏', 'error');
                log(`–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${error.message}`, 'error');
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('load', function() {
            log('–°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
            checkTelegramWebApp();
        });

        // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫
        window.addEventListener('error', function(e) {
            log(`JavaScript –æ—à–∏–±–∫–∞: ${e.message}`, 'error');
        });

        // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –ø—Ä–æ–º–∏—Å–æ–≤
        window.addEventListener('unhandledrejection', function(e) {
            log(`–ù–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–æ–º–∏—Å–∞: ${e.reason}`, 'error');
        });
    </script>
</body>
</html> 