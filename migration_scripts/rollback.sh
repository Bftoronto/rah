#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –æ—Ç–∫–∞—Ç–∞ –º–∏–≥—Ä–∞—Ü–∏–∏: Selectel ‚Üí Render
# –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —Å–ª—É—á–∞–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º

set -e

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# –§—É–Ω–∫—Ü–∏–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
log() {
    echo -e "${GREEN}[$(date +'%Y-%m-%d %H:%M:%S')] $1${NC}"
}

error() {
    echo -e "${RED}[$(date +'%Y-%m-%d %H:%M:%S')] ERROR: $1${NC}"
}

warning() {
    echo -e "${YELLOW}[$(date +'%Y-%m-%d %H:%M:%S')] WARNING: $1${NC}"
}

# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
SELECTEL_SERVER="31.41.155.88"
RENDER_SERVER="https://pax-backend-2gng.onrender.com"
ROLLBACK_LOG="rollback.log"

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø–∏—Å–∏ –≤ –ª–æ–≥
log_to_file() {
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] $1" >> $ROLLBACK_LOG
}

# –§—É–Ω–∫—Ü–∏—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
confirm_rollback() {
    echo ""
    echo "‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –í—ã —Å–æ–±–∏—Ä–∞–µ—Ç–µ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –æ—Ç–∫–∞—Ç –º–∏–≥—Ä–∞—Ü–∏–∏!"
    echo "–≠—Ç–æ –ø—Ä–∏–≤–µ–¥–µ—Ç –∫:"
    echo "- –û—Å—Ç–∞–Ω–æ–≤–∫–µ —Å–µ—Ä–≤–∏—Å–æ–≤ –Ω–∞ Selectel"
    echo "- –í–æ–∑–≤—Ä–∞—Ç—É –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é Render"
    echo "- –í–æ–∑–º–æ–∂–Ω–æ–π –ø–æ—Ç–µ—Ä–µ –¥–∞–Ω–Ω—ã—Ö, —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏"
    echo ""
    read -p "–í—ã —É–≤–µ—Ä–µ–Ω—ã? (yes/no): " -r
    if [[ ! $REPLY =~ ^[Yy][Ee][Ss]$ ]]; then
        echo "–û—Ç–∫–∞—Ç –æ—Ç–º–µ–Ω–µ–Ω"
        exit 0
    fi
}

# –§—É–Ω–∫—Ü–∏—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–µ—Ä–≤–∏—Å–æ–≤ –Ω–∞ Selectel
stop_selectel_services() {
    log "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤ –Ω–∞ Selectel..."
    
    ssh root@$SELECTEL_SERVER << 'EOF'
cd /opt/pax-backend
if [ -f "docker-compose.yml" ]; then
    echo "–û—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
    docker-compose down
    echo "–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
else
    echo "Docker Compose —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω"
fi

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ systemd —Å–µ—Ä–≤–∏—Å–∞
if systemctl is-active --quiet pax-backend.service; then
    echo "–û—Å—Ç–∞–Ω–æ–≤–∫–∞ systemd —Å–µ—Ä–≤–∏—Å–∞..."
    systemctl stop pax-backend.service
    systemctl disable pax-backend.service
    echo "–°–µ—Ä–≤–∏—Å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –æ—Ç–∫–ª—é—á–µ–Ω"
fi
EOF
    
    log "‚úÖ –°–µ—Ä–≤–∏—Å—ã –Ω–∞ Selectel –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
}

# –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ Render
check_render_status() {
    log "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ Render..."
    
    if curl -f "$RENDER_SERVER/health" > /dev/null 2>&1; then
        log "‚úÖ Render –¥–æ—Å—Ç—É–ø–µ–Ω"
        return 0
    else
        error "‚ùå Render –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
        return 1
    fi
}

# –§—É–Ω–∫—Ü–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö (–µ—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ)
restore_data() {
    log "üíæ –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö..."
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–∞ Selectel
    ssh root@$SELECTEL_SERVER << 'EOF'
cd /opt/pax-backend
if [ -f "docker-compose.yml" ]; then
    # –°–æ–∑–¥–∞–µ–º –±—ç–∫–∞–ø —Ç–µ–∫—É—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö
    echo "–°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞ —Ç–µ–∫—É—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö..."
    docker-compose exec -T postgres pg_dump -U rideshare_user ridesharing > /tmp/selectel_backup.sql
    echo "–ë—ç–∫–∞–ø —Å–æ–∑–¥–∞–Ω: /tmp/selectel_backup.sql"
fi
EOF
    
    log "‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã (–µ—Å–ª–∏ –±—ã–ª–∏)"
}

# –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π
update_configurations() {
    log "‚öôÔ∏è –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π..."
    
    # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è DNS, –ø—Ä–æ–∫—Å–∏ –∏ —Ç.–¥.
    warning "‚ö†Ô∏è –ù–µ –∑–∞–±—É–¥—å—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å:"
    echo "- DNS –∑–∞–ø–∏—Å–∏ (–µ—Å–ª–∏ –∏–∑–º–µ–Ω—è–ª–∏—Å—å)"
    echo "- –ü—Ä–æ–∫—Å–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏"
    echo "- SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã"
    echo "- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–∏—Å—Ç–µ–º—ã"
}

# –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ç—á–µ—Ç–∞ –æ–± –æ—Ç–∫–∞—Ç–µ
create_rollback_report() {
    log "üìä –°–æ–∑–¥–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞ –æ–± –æ—Ç–∫–∞—Ç–µ..."
    
    cat > "rollback_report.txt" << EOF
–û–¢–ß–ï–¢ –û–ë –û–¢–ö–ê–¢–ï –ú–ò–ì–†–ê–¶–ò–ò: Selectel ‚Üí Render
==============================================
–î–∞—Ç–∞ –æ—Ç–∫–∞—Ç–∞: $(date)
–í—Ä–µ–º—è: $(date +%H:%M:%S)

–ü–†–ò–ß–ò–ù–ê –û–¢–ö–ê–¢–ê:
- –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å Selectel
- –ü—Ä–æ–±–ª–µ–º—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- –ü—Ä–æ–±–ª–µ–º—ã —Å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å—é
- –î—Ä—É–≥–∏–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

–í–´–ü–û–õ–ù–ï–ù–ù–´–ï –î–ï–ô–°–¢–í–ò–Ø:
1. ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ—Ç–∫–∞—Ç–∞
2. ‚úÖ –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤ –Ω–∞ Selectel
3. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ Render
4. ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (–µ—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ)
5. ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π

–°–¢–ê–¢–£–° –°–ï–†–í–ï–†–û–í:
- Selectel ($SELECTEL_SERVER): –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
- Render ($RENDER_SERVER): $(if curl -f $RENDER_SERVER/health > /dev/null 2>&1; then echo "‚úÖ –î–æ—Å—Ç—É–ø–µ–Ω"; else echo "‚ùå –ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω"; fi)

–°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò:
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ Render
2. –û–±–Ω–æ–≤–∏—Ç—å DNS –∑–∞–ø–∏—Å–∏ (–µ—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ)
3. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
4. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏—á–∏–Ω—ã –æ—Ç–∫–∞—Ç–∞
5. –ü–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω—É—é –º–∏–≥—Ä–∞—Ü–∏—é

–í–ê–ñ–ù–û:
- –í—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã
- Render —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ
- –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏—á–∏–Ω—ã –æ—Ç–∫–∞—Ç–∞
- –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –ø–ª–∞–Ω –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏

–ö–û–ù–¢–ê–ö–¢–´:
- Render API: $RENDER_SERVER
- –õ–æ–≥ –æ—Ç–∫–∞—Ç–∞: $ROLLBACK_LOG
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–ª–µ—Ä—Ç—ã –¥–ª—è Render

–°–¢–ê–¢–£–° –û–¢–ö–ê–¢–ê: ‚úÖ –ó–ê–í–ï–†–®–ï–ù
EOF

    log "‚úÖ –û—Ç—á–µ—Ç –æ–± –æ—Ç–∫–∞—Ç–µ —Å–æ–∑–¥–∞–Ω: rollback_report.txt"
}

# –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
main() {
    echo "üîÑ –ù–ê–ß–ê–õ–û –û–¢–ö–ê–¢–ê –ú–ò–ì–†–ê–¶–ò–ò: Selectel ‚Üí Render"
    echo "=============================================="
    echo "–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞: $(date)"
    echo "–õ–æ–≥ —Ñ–∞–π–ª: $ROLLBACK_LOG"
    echo ""
    
    # –°–æ–∑–¥–∞–Ω–∏–µ –ª–æ–≥ —Ñ–∞–π–ª–∞
    echo "=== –ù–ê–ß–ê–õ–û –û–¢–ö–ê–¢–ê $(date) ===" > $ROLLBACK_LOG
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
    if [ "$1" = "--help" ]; then
        echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 [--force|--help]"
        echo ""
        echo "–û–ø—Ü–∏–∏:"
        echo "  --force    –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ"
        echo "  --help     –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É"
        exit 0
    fi
    
    # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ (–µ—Å–ª–∏ –Ω–µ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π —Ä–µ–∂–∏–º)
    if [[ "$*" != *"--force"* ]]; then
        confirm_rollback
    else
        warning "–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π —Ä–µ–∂–∏–º - –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø—Ä–æ–ø—É—â–µ–Ω–æ"
    fi
    
    log_to_file "–û—Ç–∫–∞—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω"
    
    # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤ –Ω–∞ Selectel
    stop_selectel_services
    log_to_file "–°–µ—Ä–≤–∏—Å—ã –Ω–∞ Selectel –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ Render
    if check_render_status; then
        log_to_file "Render –¥–æ—Å—Ç—É–ø–µ–Ω"
    else
        error "‚ùå Render –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω - –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞!"
        log_to_file "Render –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
        exit 1
    fi
    
    # –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (–µ—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ)
    restore_data
    log_to_file "–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã"
    
    # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π
    update_configurations
    log_to_file "–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã"
    
    # –°–æ–∑–¥–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞
    create_rollback_report
    log_to_file "–û—Ç—á–µ—Ç —Å–æ–∑–¥–∞–Ω"
    
    echo ""
    echo "üîÑ –û–¢–ö–ê–¢ –ó–ê–í–ï–†–®–ï–ù!"
    echo "=================="
    echo "–í—Ä–µ–º—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è: $(date)"
    echo ""
    echo "üìã –°—Ç–∞—Ç—É—Å:"
    echo "- Selectel: –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    echo "- Render: $(if curl -f $RENDER_SERVER/health > /dev/null 2>&1; then echo "‚úÖ –î–æ—Å—Ç—É–ø–µ–Ω"; else echo "‚ùå –ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω"; fi)"
    echo ""
    echo "üìã –û—Ç—á–µ—Ç—ã:"
    echo "- –û—Ç—á–µ—Ç –æ–± –æ—Ç–∫–∞—Ç–µ: rollback_report.txt"
    echo "- –õ–æ–≥: $ROLLBACK_LOG"
    echo ""
    echo "üåê Render API: $RENDER_SERVER"
    echo ""
    echo "‚ö†Ô∏è –í–ê–ñ–ù–û:"
    echo "1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ Render"
    echo "2. –û–±–Ω–æ–≤–∏—Ç–µ DNS –∑–∞–ø–∏—Å–∏ (–µ—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ)"
    echo "3. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥"
    echo "4. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –ø—Ä–∏—á–∏–Ω—ã –æ—Ç–∫–∞—Ç–∞"
}

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
trap 'error "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ —Å—Ç—Ä–æ–∫–µ $LINENO"; exit 1' ERR

# –ó–∞–ø—É—Å–∫ –≥–ª–∞–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
main "$@" 